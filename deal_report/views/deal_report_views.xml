<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>
    <!-- Actions -->
    <record id="action_deal_report_all" model="ir.actions.act_window">
      <field name="name">All Deals</field>
      <field name="res_model">deal.report</field>
      <field name="view_mode">tree,form,pivot,graph</field>
      <field name="search_view_id" ref="deal_report_search_view"/>
      <field name="context">{}</field>
    </record>

    <record id="action_deal_report_primary" model="ir.actions.act_window">
      <field name="name">Primary Deals</field>
      <field name="res_model">deal.report</field>
      <field name="view_mode">tree,form,pivot,graph</field>
      <field name="search_view_id" ref="deal_report_search_view"/>
      <field name="domain">[("sales_type", "=", "primary")]</field>
      <field name="context">{'default_sales_type': 'primary', 'search_default_primary': 1}</field>
    </record>

    <record id="action_deal_report_secondary" model="ir.actions.act_window">
      <field name="name">Secondary Deals</field>
      <field name="res_model">deal.report</field>
      <field name="view_mode">tree,form,pivot,graph</field>
      <field name="search_view_id" ref="deal_report_search_view"/>
      <field name="domain">[("sales_type", "=", "secondary")]</field>
      <field name="context">{'default_sales_type': 'secondary', 'search_default_secondary': 1}</field>
    </record>

    <record id="action_deal_report_exclusive" model="ir.actions.act_window">
      <field name="name">Exclusive Deals</field>
      <field name="res_model">deal.report</field>
      <field name="view_mode">tree,form,pivot,graph</field>
      <field name="search_view_id" ref="deal_report_search_view"/>
      <field name="domain">[("sales_type", "=", "exclusive")]</field>
      <field name="context">{'default_sales_type': 'exclusive', 'search_default_exclusive': 1}</field>
    </record>

    <record id="action_deal_report_rental" model="ir.actions.act_window">
      <field name="name">Rental Deals</field>
      <field name="res_model">deal.report</field>
      <field name="view_mode">tree,form,pivot,graph</field>
      <field name="search_view_id" ref="deal_report_search_view"/>
      <field name="domain">[("sales_type", "=", "rental")]</field>
      <field name="context">{'default_sales_type': 'rental', 'search_default_rental': 1}</field>
    </record>

    <!-- Tree View -->
    <record id="deal_report_tree_view" model="ir.ui.view">
      <field name="name">deal.report.tree</field>
      <field name="model">deal.report</field>
      <field name="arch" type="xml">
        <tree decoration-info="state == 'draft'" decoration-success="state == 'done'" decoration-warning="state == 'commissioned'" decoration-muted="state == 'cancelled'">
          <field name="name"/>
          <field name="sales_type" widget="badge"/>
          <field name="booking_date"/>
          <field name="primary_buyer_id"/>
          <field name="project_id"/>
          <field name="unit_id"/>
          <field name="sales_value" sum="Sales"/>
          <field name="total_with_vat" sum="Total With VAT"/>
          <field name="total_commission_amount" sum="Total Commission"/>
          <field name="commission_status"/>
          <field name="state" widget="badge"/>
        </tree>
      </field>
    </record>

    <!-- Search View -->
    <record id="deal_report_search_view" model="ir.ui.view">
      <field name="name">deal.report.search</field>
      <field name="model">deal.report</field>
      <field name="arch" type="xml">
        <search string="Search Deals">
          <field name="name"/>
          <field name="primary_buyer_id"/>
          <field name="project_id"/>
          <field name="unit_id"/>
          <filter name="draft" string="Draft" domain="[( 'state', '=', 'draft')]"/>
          <filter name="confirmed" string="Confirmed" domain="[( 'state', '=', 'confirmed')]"/>
          <filter name="commissioned" string="Commissioned" domain="[( 'state', '=', 'commissioned')]"/>
          <filter name="done" string="Done" domain="[( 'state', '=', 'done')]"/>
          <filter name="primary" string="Primary" domain="[( 'sales_type', '=', 'primary')]"/>
          <filter name="secondary" string="Secondary" domain="[( 'sales_type', '=', 'secondary')]"/>
          <filter name="rental" string="Rental" domain="[( 'sales_type', '=', 'rental')]"/>
          <filter name="exclusive" string="Exclusive" domain="[( 'sales_type', '=', 'exclusive')]"/>
          <group expand="0" string="Group By">
            <filter name="group_sales_type" string="Sales Type" context="{'group_by': 'sales_type'}"/>
            <filter name="group_state" string="State" context="{'group_by': 'state'}"/>
            <filter name="group_booking" string="Booking Date" context="{'group_by': 'booking_date'}"/>
            <filter name="group_project" string="Project" context="{'group_by': 'project_id'}"/>
          </group>
        </search>
      </field>
    </record>

    <!-- Form View -->
    <record id="deal_report_form_view" model="ir.ui.view">
      <field name="name">deal.report.form</field>
      <field name="model">deal.report</field>
      <field name="arch" type="xml">
        <form string="Deal" create="true" edit="true">
          <header>
            <button name="action_confirm" type="object" string="Confirm Deal" class="btn-primary" attrs="{'invisible': [('state', '!=', 'draft')]}"/>
            <button name="action_generate_commission_lines" type="object" string="Generate Commission Lines" attrs="{'invisible': [('state', 'not in', ['confirmed', 'commissioned'])]}"/>
            <button name="action_process_commissions_to_bills" type="object" string="Process Commissions to Bills" class="btn-primary" attrs="{'invisible': ['|', ('state', 'not in', ['confirmed', 'invoiced', 'commissioned']), ('commission_processed', '=', True)]}"/>
            <button name="action_set_invoiced" type="object" string="Mark Invoiced" attrs="{'invisible': [('state', '!=', 'confirmed')]}"/>
            <button name="action_set_done" type="object" string="Mark Done" class="btn-success" attrs="{'invisible': [('state', '!=', 'commissioned')]}"/>
            <button name="action_reset_to_draft" type="object" string="Reset to Draft" attrs="{'invisible': [('state', 'not in', ['confirmed', 'commissioned', 'invoiced', 'done'])]}"/>
            <button name="action_cancel" type="object" string="Cancel" class="btn-secondary" attrs="{'invisible': [('state', 'in', ['done', 'cancelled'])]}"/>
            <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,invoiced,commissioned,done,cancelled"/>
          </header>
          <sheet>
            <div class="oe_button_box" name="button_box">
              <button name="action_view_invoices" type="object" class="oe_stat_button" icon="fa-file-text-o">
                <field name="invoice_count" widget="statinfo" string="Invoices"/>
              </button>
              <button name="action_view_commissions" type="object" class="oe_stat_button" icon="fa-percent">
                <field name="commission_count" widget="statinfo" string="Commissions"/>
              </button>
              <button name="action_view_bills" type="object" class="oe_stat_button" icon="fa-money">
                <field name="bill_count" widget="statinfo" string="Bills"/>
              </button>
              <button name="action_view_documents" type="object" class="oe_stat_button" icon="fa-files-o"/>
            </div>

            <group>
              <group string="Deal Information">
                <field name="name" readonly="1"/>
                <field name="sales_type" required="1"/>
                <field name="booking_date" required="1"/>
                <field name="estimated_invoice_date"/>
              </group>
              <group string="Parties">
                <field name="primary_buyer_id" required="1"/>
                <field name="secondary_buyer_id"/>
                <field name="customer_ids" widget="many2many_tags"/>
              </group>
              <group string="Property Details">
                <field name="project_id" required="1"/>
                <field name="unit_id" required="1"/>
                <field name="unit_type"/>
              </group>
              <group string="Financial Summary">
                <field name="currency_id" readonly="1"/>
                <field name="sales_value" required="1"/>
                <field name="vat_rate"/>
                <field name="vat_amount" readonly="1"/>
                <field name="total_without_vat" readonly="1"/>
                <field name="total_with_vat" readonly="1"/>
              </group>
            </group>

            <notebook>
              <page string="External Commission">
                <group string="Broker">
                  <field name="broker_partner_id"/>
                  <field name="broker_commission_type"/>
                  <field name="broker_calculation_base"/>
                  <field name="broker_rate"/>
                  <field name="broker_amount" readonly="1"/>
                </group>
                <group string="Referrer">
                  <field name="referrer_partner_id"/>
                  <field name="referrer_commission_type"/>
                  <field name="referrer_calculation_base"/>
                  <field name="referrer_rate"/>
                  <field name="referrer_amount" readonly="1"/>
                </group>
                <group string="Cashback">
                  <field name="cashback_partner_id"/>
                  <field name="cashback_commission_type"/>
                  <field name="cashback_calculation_base"/>
                  <field name="cashback_rate"/>
                  <field name="cashback_amount" readonly="1"/>
                </group>
                <group string="Other External">
                  <field name="other_external_partner_id"/>
                  <field name="other_external_commission_type"/>
                  <field name="other_external_calculation_base"/>
                  <field name="other_external_rate"/>
                  <field name="other_external_amount" readonly="1"/>
                </group>
                <group string="External Summary">
                  <field name="total_external_commission" readonly="1" class="oe_inline"/>
                </group>
              </page>

              <page string="Internal Commission">
                <group string="Agent 1">
                  <field name="agent1_partner_id"/>
                  <field name="agent1_commission_type"/>
                  <field name="agent1_calculation_base"/>
                  <field name="agent1_rate"/>
                  <field name="agent1_amount" readonly="1"/>
                </group>
                <group string="Agent 2">
                  <field name="agent2_partner_id"/>
                  <field name="agent2_commission_type"/>
                  <field name="agent2_calculation_base"/>
                  <field name="agent2_rate"/>
                  <field name="agent2_amount" readonly="1"/>
                </group>
                <group string="Manager">
                  <field name="manager_partner_id"/>
                  <field name="manager_commission_type"/>
                  <field name="manager_calculation_base"/>
                  <field name="manager_rate"/>
                  <field name="manager_amount" readonly="1"/>
                </group>
                <group string="Director">
                  <field name="director_partner_id"/>
                  <field name="director_commission_type"/>
                  <field name="director_calculation_base"/>
                  <field name="director_rate"/>
                  <field name="director_amount" readonly="1"/>
                </group>
                <group string="Internal Summary">
                  <field name="total_internal_commission" readonly="1" class="oe_inline"/>
                </group>
              </page>

              <page string="Commission Lines">
                <group>
                  <field name="commission_line_ids" context="{'default_deal_id': id}" nolabel="1">
                    <tree editable="bottom">
                      <field name="commission_partner_id"/>
                      <field name="commission_type"/>
                      <field name="role"/>
                      <field name="commission_category"/>
                      <field name="calculation_method"/>
                      <field name="calculation_base"/>
                      <field name="commission_rate"/>
                      <field name="commission_amount"/>
                      <field name="state"/>
                      <field name="bill_id"/>
                    </tree>
                  </field>
                  <button name="action_generate_commission_lines" type="object" string="Regenerate Commission Lines" class="btn-secondary"/>
                </group>
              </page>

              <page string="Bill Lines">
                <field name="bill_line_ids" nolabel="1">
                  <tree>
                    <field name="bill_id"/>
                    <field name="partner_id"/>
                    <field name="description"/>
                    <field name="quantity"/>
                    <field name="price_unit"/>
                    <field name="price_subtotal"/>
                    <field name="price_total"/>
                    <field name="state"/>
                  </tree>
                </field>
              </page>

              <page string="Documents">
                <group>
                  <group string="KYC Documents">
                    <field name="kyc_document_ids" widget="many2many_binary" nolabel="1"/>
                  </group>
                  <group string="Booking Forms">
                    <field name="booking_form_ids" widget="many2many_binary" nolabel="1"/>
                  </group>
                  <group string="SPA Documents">
                    <field name="spa_document_ids" widget="many2many_binary" nolabel="1"/>
                  </group>
                  <group string="Passports">
                    <field name="passport_ids" widget="many2many_binary" nolabel="1"/>
                  </group>
                  <group string="Other Documents">
                    <field name="document_ids" widget="many2many_binary" nolabel="1"/>
                  </group>
                </group>
              </page>

              <page string="Commission Summary">
                <group>
                  <field name="company_share" readonly="1"/>
                  <field name="net_company_share" readonly="1"/>
                  <field name="total_commission_amount" readonly="1"/>
                  <field name="total_external_commission" readonly="1"/>
                  <field name="total_internal_commission" readonly="1"/>
                  <field name="commission_status" readonly="1"/>
                  <field name="commission_processed" readonly="1"/>
                  <field name="is_fully_invoiced" readonly="1"/>
                  <field name="has_posted_invoices" readonly="1"/>
                </group>
              </page>
            </notebook>
          </sheet>
        </form>
      </field>
    </record>
  </data>
</odoo>
